# -*- coding: utf-8 -*-
"""Spark

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1Vqbc8VBIR9DeAGp-jRz17S32yLuowyeT
"""

!apt-get install openjdk-8-jdk-headless -qq > /dev/null 
!wget -q https://downloads.apache.org/spark/spark-2.4.8/spark-2.4.8-bin-hadoop2.7.tgz 
!tar xf spark-2.4.8-bin-hadoop2.7.tgz

import os 
os.environ["JAVA_HOME"] = "/usr/lib/jvm/java-8-openjdk-amd64" 
os.environ["SPARK_HOME"] = "/content/spark-2.4.8-bin-hadoop2.7"

!pip install findspark
import findspark 
findspark.init()

!pip install findspark
import findspark 
findspark.init()

import pyspark
sc = pyspark.SparkContext()

readme = sc.textFile('/content/spark-2.4.8-bin-hadoop2.7/README.md')
readme.count()

readme.map(lambda word:word .upper()).collect()

readme.map(lambda word:word .upper()).take(1)

readme.map(lambda readme:(readme,len(readme))).collect()

from pyspark.sql import SparkSession
spark = SparkSession \
        .builder \
        .appName('Python Spark DataFrame Example') \
        .getOrCreate()

kiva = spark.read.csv('/content/kiva_el.csv',sep=',',
                      header='true',inferSchema='true')
kiva.printSchema()

kiva.show(5)

df = kiva.limit(5).toPandas()
df

kiva = kiva.withColumnRenamed('LocationName','Location')
kiva.show()

kiva_select = kiva.select('region','activity','sector',
                          'loan_amount','funded_amount')
kiva_select.show(2)

kiva_select.filter((kiva_select.loan_amount > 100) 
              & (kiva_select.activity == 'Livestock')).show()

from pyspark.sql import functions as F

kiva_select.groupby(['sector','activity']).agg(
    F.sum('funded_amount').alias('Total Funded Amount')
).show()

from pyspark.sql import SQLContext

sqlContext = SQLContext(sc)
kiva_select.registerTempTable('kiva_table')

kiva_sql = sqlContext.sql('SELECT * FROM kiva_table WHERE funded_amount>100  ORDER BY funded_amount DESC')

kiva_sql.show()